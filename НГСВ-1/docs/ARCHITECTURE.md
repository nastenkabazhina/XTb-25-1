# Визуализация архитектуры

## Структура приложения

```
┌─────────────────────────────────────────────────────────────────┐
│                     Веб-браузер                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    index-new.html                                │
│  ┌───────────────┐  ┌────────────────┐  ┌──────────────────┐   │
│  │  Управление   │  │    Цифровой    │  │  Рекомендации    │   │
│  │   (Левая      │  │     двойник    │  │    (Правая       │   │
│  │   панель)     │  │   (Визуализа-  │  │    панель)       │   │
│  │               │  │      ция)      │  │                  │   │
│  └───────────────┘  └────────────────┘  └──────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
         │                    │                      │
         └────────────────────┴──────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────────┐
        │            JavaScript Модули                 │
        └─────────────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┐
         │                    │                    │
         ▼                    ▼                    ▼
┌────────────────┐   ┌────────────────┐   ┌──────────────┐
│  controller.js │   │    view.js     │   │   model.js   │
│                │   │                │   │              │
│  Контроллер    │◄──┤ Представление  │   │   Модель     │
│                │   │                │   │              │
│ • События      │   │ • DOM          │   │ • Состояние  │
│ • Синхрониза-  │   │ • Отображение  │   │ • Расчеты    │
│   ция          │   │ • Анимации     │   │ • Формулы    │
│ • Координация  │──►│                │   │ • Симуляция  │
│                │   │                │◄──┤              │
└────────────────┘   └────────────────┘   └──────────────┘
         │                    │                    │
         │                    ▼                    │
         │           ┌────────────────┐            │
         │           │   styles.css   │            │
         │           │                │            │
         │           │ • Цвета        │            │
         │           │ • Layout       │            │
         │           │ • Анимации     │            │
         │           └────────────────┘            │
         │                                         │
         └─────────────────┬───────────────────────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │  Система рекомендаций   │
              │  (27 комбинаций)        │
              └─────────────────────────┘
```

## Поток данных (Data Flow)

```
                     Пользователь
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    UI События                            │
│  • Клик на клапан                                        │
│  • Изменение слайдера                                    │
│  • Клик на насос                                         │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
          ┌────────────────────────┐
          │      Controller        │
          │  bindControl()         │
          │  bindClick()           │
          └────────┬───────────────┘
                   │
                   ▼
     ┌─────────────────────────────┐
     │         Model               │
     │  updateParameter()          │
     │  toggleValve()              │
     │  calculatePressure()        │
     │  getRecommendations()       │
     └─────┬───────────────────────┘
           │
           │ notify() → Observer pattern
           │
           ▼
     ┌─────────────────────────────┐
     │      Controller             │
     │  onStateChange()            │
     │  updateUI()                 │
     └─────┬───────────────────────┘
           │
           ▼
     ┌─────────────────────────────┐
     │         View                │
     │  updatePressure()           │
     │  updateLevels()             │
     │  updateRecommendations()    │
     └─────┬───────────────────────┘
           │
           ▼
     ┌─────────────────────────────┐
     │          DOM                │
     │  Визуальные обновления      │
     └─────────────────────────────┘
           │
           ▼
        Пользователь видит изменения
```

## Разделение ответственности

```
┌─────────────────────────────────────────────────────────────┐
│                       FRONTEND                               │
│  (Всё, что связано с визуализацией)                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  📄 index-new.html                                           │
│  ├── HTML структура                                          │
│  ├── Разметка интерфейса                                     │
│  └── Подключение модулей                                     │
│                                                              │
│  🎨 css/styles.css                                           │
│  ├── Цветовая палитра                                        │
│  ├── Layout (Grid, Flexbox)                                  │
│  ├── Стили компонентов                                       │
│  └── Анимации                                                │
│     ├── Течение жидкости                                     │
│     ├── Пузырьки газа                                        │
│     └── Мигание алертов                                      │
│                                                              │
│  👁️ js/view.js (класс SeparatorView)                        │
│  ├── Получение ссылок на DOM элементы                        │
│  ├── Функции отображения                                     │
│  │   ├── updatePressure()                                    │
│  │   ├── updateSeparatorLevels()                             │
│  │   ├── updateValveState()                                  │
│  │   └── updateRecommendations()                             │
│  ├── Привязка событий                                        │
│  │   ├── bindControl()                                       │
│  │   └── bindClick()                                         │
│  └── Управление алертами                                     │
│      ├── showAlert()                                         │
│      └── hideAlert()                                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       BACKEND                                │
│  (Вся бизнес-логика и расчёты)                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  🧮 js/model.js (класс SeparatorModel)                       │
│  ├── Состояние системы (state)                              │
│  │   ├── Параметры регуляторов                              │
│  │   ├── Состояние клапанов                                 │
│  │   └── Уровни фаз                                         │
│  │                                                           │
│  ├── Расчётные функции                                       │
│  │   ├── calculatePressure()                                 │
│  │   │   └── P = 20.0 - 19.9 × sqrt((K - 0.1) / (0.9 × (1 + Q/8000)))    │
│  │   ├── calculateWaterContent()                             │
│  │   │   └── Q = Cv × u × √ΔP                                │
│  │   └── calculateOilLevel()                                 │
│  │       └── Q = Cv × u × √ΔP                                │
│  │                                                           │
│  ├── Классификация параметров                                │
│  │   ├── getPressureCategory()                               │
│  │   │   ├── < 6 МПа → low                                   │
│  │   │   ├── 6-16 МПа → normal                               │
│  │   │   └── > 16 МПа → high                                 │
│  │   ├── getWaterLevelCategory()                             │
│  │   └── getOilLevelCategory()                               │
│  │                                                           │
│  ├── Система рекомендаций                                    │
│  │   └── getRecommendations()                                │
│  │       └── 27 комбинаций (3×3×3)                           │
│  │                                                           │
│  ├── Проверка аварий                                         │
│  │   └── checkAlerts()                                       │
│  │       ├── Давление                                        │
│  │       ├── Обводнённость                                   │
│  │       ├── Уровень нефти                                   │
│  │       └── Уровни в сепараторе                             │
│  │                                                           │
│  └── Симуляция процесса                                      │
│      └── simulate()                                          │
│          ├── Разделение эмульсии                             │
│          │   ├── 35% вода                                    │
│          │   ├── 40% нефть                                   │
│          │   └── 25% газ                                     │
│          └── Откачка через клапаны                           │
│                                                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     CONTROLLER                               │
│  (Связь между Frontend и Backend)                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  🎮 js/controller.js (класс SeparatorController)             │
│  ├── Инициализация                                           │
│  │   ├── init()                                              │
│  │   ├── setupTabs()                                         │
│  │   ├── bindControls()                                      │
│  │   └── startSimulation()                                   │
│  │                                                           │
│  ├── Обработка событий                                       │
│  │   ├── Слайдеры регуляторов                                │
│  │   ├── Клики на клапаны                                    │
│  │   └── Клик на насос                                       │
│  │                                                           │
│  ├── Синхронизация                                           │
│  │   ├── Клапаны ↔ Слайдеры                                  │
│  │   └── Модель ↔ Представление                              │
│  │                                                           │
│  └── Координация обновлений                                  │
│      ├── updatePressure()                                    │
│      ├── updateWaterContent()                                │
│      ├── updateOilLevel()                                    │
│      ├── updateLevels()                                      │
│      ├── updateValves()                                      │
│      ├── updateRecommendations()                             │
│      ├── checkAlerts()                                       │
│      └── tick() - симуляция                                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## Жизненный цикл приложения

```
1. Загрузка страницы
   │
   ├─► Загрузка HTML (index-new.html)
   ├─► Загрузка CSS (styles.css)
   └─► Загрузка JS модулей
       ├─► model.js
       ├─► view.js
       └─► controller.js

2. Инициализация
   │
   ├─► Создание экземпляров
   │   ├─► const model = new SeparatorModel();
   │   ├─► const view = new SeparatorView();
   │   └─► const controller = new SeparatorController(model, view);
   │
   └─► Controller.init()
       ├─► Привязка событий
       ├─► Подписка на изменения модели
       ├─► Начальное обновление UI
       └─► Запуск симуляции (setInterval)

3. Работа приложения
   │
   ├─► Пользовательский ввод
   │   │
   │   ├─► Изменение слайдера
   │   │   └─► Controller → Model → View
   │   │
   │   ├─► Клик на клапан
   │   │   └─► Controller → Model.toggleValve() → View
   │   │
   │   └─► Клик на насос
   │       └─► Controller → Model.increasePumpFlow() → View
   │
   ├─► Симуляция (каждые 900мс)
   │   └─► Model.simulate()
   │       ├─► Обновление уровней
   │       ├─► Проверка алертов
   │       └─► Обновление рекомендаций
   │
   └─► Обновление UI
       └─► View обновляет DOM
           ├─► Визуализация уровней
           ├─► Состояние клапанов
           ├─► Анимации потоков
           └─► Рекомендации

4. Непрерывный цикл
   │
   └─► Возврат к пункту 3
```

## Паттерны проектирования

### 1. MVC (Model-View-Controller)
```
┌──────────┐      ┌──────────┐      ┌──────────┐
│  Model   │◄─────┤Controller│─────►│   View   │
│          │      │          │      │          │
│ Данные + │      │ Логика   │      │ Отобра-  │
│ Бизнес-  │      │ взаимо-  │      │ жение    │
│ логика   │      │ действия │      │          │
└──────────┘      └──────────┘      └──────────┘
     │                                    │
     └────────────────┬───────────────────┘
                      │
                   Разделение
                ответственности
```

### 2. Observer (Наблюдатель)
```
┌────────────────────┐
│      Model         │
│                    │
│  subscribe(fn)     │
│  notify()          │
└──────────┬─────────┘
           │
           │ notify() при изменениях
           │
           ▼
┌──────────────────────┐
│    Controller        │
│                      │
│  onStateChange()     │
│    └─► updateUI()    │
└──────────────────────┘
```

### 3. Module Pattern (Модули)
```
Каждый файл - отдельный модуль:
├─► model.js
│   └─► class SeparatorModel { ... }
├─► view.js
│   └─► class SeparatorView { ... }
└─► controller.js
    └─► class SeparatorController { ... }
```

## Масштабируемость

```
Текущая структура:

┌─────────────────────┐
│   SeparatorModel    │
├─────────────────────┤
│ • Давление          │
│ • Вода              │
│ • Нефть             │
└─────────────────────┘

Легко расширяется до:

┌─────────────────────┐     ┌──────────────────┐
│   SeparatorModel    │────►│  TemperatureSensor│
├─────────────────────┤     └──────────────────┘
│ • Давление          │     ┌──────────────────┐
│ • Вода              │────►│  FlowMeter       │
│ • Нефть             │     └──────────────────┘
│ • [Новые модули]    │     ┌──────────────────┐
└─────────────────────┘────►│  SafetySystem    │
                            └──────────────────┘
```
