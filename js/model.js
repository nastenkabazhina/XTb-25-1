/**
 * Model - Business Logic Layer
 * Отвечает за расчёты, состояние системы и бизнес-логику
 */

class SeparatorModel {
  constructor() {
    // Состояние системы
    this.state = {
      // Регулятор давления
      kvs: 0.5,           // Раскрытие клапана (0-1)
      flow: 100,          // Расход жидкости (м³/сут)
      inletFlow: 5000,     // Входной поток (м³/сут)
      
      // Регулятор воды (новые параметры)
      waterK: 0.5,        // Степень открытия клапана (0-1)
      waterQ: 100,        // Расход жидкости (м³/сут)
      
      // Регулятор нефти
      oilCv: 20,          // Коэффициент пропускной способности (м³/ч)
      oilDp: 4,           // Перепад давления (бар)
      oilU: 0.5,          // Степень открытия клапана (0-1)
      
      // Состояние клапанов
      waterValve: true,   // Открыт/закрыт
      oilValve: true,
      gasValve: true,
      
      // Уровни фаз (%)
      waterLevel: 30,
      oilLevel: 30,
      gasLevel: 40
    };
    
    // Слушатели изменений
    this.listeners = [];
  }
  
  /**
   * Подписка на изменения состояния
   */
  subscribe(listener) {
    this.listeners.push(listener);
  }
  
  /**
   * Уведомление слушателей
   */
  notify() {
    this.listeners.forEach(listener => listener(this.state));
  }
  
  /**
   * Обновление параметра
   */
  updateParameter(key, value) {
    this.state[key] = value;
    this.notify();
  }
  
  /**
   * Расчёт давления
   * P (в МПа) = 20.0 - 19.9 * sqrt( (K - 0.1) / (0.9 * (1 + Q/8000)) )
   * где K - степень открытия клапана воды (waterK), Q - расход эмульсии (inletFlow, м³/сут)
   */
  calculatePressure() {
    // Формула: давление в МПа = 20,0 - 19,9 * sqrt((K - 0,1) / (0,9 * (1 + 5000 / 8000)))
    const K = Number(this.state.waterK);
    const numerator = K - 0.1;
    const denominator = 0.9 * (1 + 5000 / 8000);
    const ratio = denominator > 0 ? numerator / denominator : 0;
    const safeRatio = Math.max(0, ratio);
    const sqrtPart = Math.sqrt(safeRatio);
    const pressureMPa = 20.0 - 19.9 * sqrtPart;
    // Ограничим диапазон давления 0..20 МПа
    return Math.max(0, Math.min(20.0, pressureMPa));
  }
  
  /**
   * Расчёт уровня воды в миллиметрах (мм)
   * Формула: уровень = минимальная_высота + рабочий_диапазон × ∛((К - 0.1) / (0.9 × (1 + Q/1000)))
   * где К - степень открытия клапана (0-1)
   *     Q - расход жидкости (м³/сут)
   */
  calculateWaterLevelMM() {
    const K = this.state.waterK;
    const Q = this.state.waterQ;
    
    const minHeight = 320;      // Минимальная высота (мм)
    const workingRange = 2560;  // Рабочий диапазон (2880 - 320 = 2560 мм)
    
    // Вычисляем кубический корень из отношения
    const numerator = K - 0.1;
    const denominator = 0.9 * (1 + Q / 1000);
    const ratio = numerator / denominator;
    const cubeRoot = Math.cbrt(ratio);
    
    // Итоговый уровень
    const level = minHeight + workingRange * cubeRoot;
    
    return level;
  }

  /**
   * Расчёт высоты нефти в мм — линейная аппроксимация по проценту уровня
   */
  calculateOilLevelMM() {
    const percent = this.state.oilLevel;
    const minHeight = 320;
    const workingRange = 2560;
    // Простейшее линейное соответствие: 0% -> minHeight, 100% -> minHeight + workingRange
    return minHeight + workingRange * (percent / 100);
  }
  
  /**
   * Расчёт уровня нефти (%)
   * Q = Cv * u * √ΔP
   */
  calculateOilLevel() {
    return this.state.oilCv * this.state.oilU * Math.sqrt(this.state.oilDp || 0);
  }
  
  /**
   * Классификация давления
   * < 6 МПа - низкое
   * 6-16 МПа - нормальное
   * > 16 МПа - высокое
   */
  getPressureCategory() {
    const p = this.calculatePressure();
    if (p < 6) return 'low';
    if (p <= 16) return 'normal';
    return 'high';
  }
  
  /**
   * Классификация уровня воды
   * < 30% - низкий
   * 30-70% - нормальный
   * > 70% - высокий
   */
  getWaterLevelCategory() {
    const w = this.state.waterLevel;
    if (w < 30) return 'low';
    if (w <= 70) return 'normal';
    return 'high';
  }
  
  /**
   * Классификация уровня нефти
   * 20-30% - низкий
   * 40-55% - нормальный
   * 60-70% - высокий
   */
  getOilLevelCategory() {
    const h = this.state.oilLevel;
    if (h >= 20 && h <= 30) return 'low';
    if (h >= 40 && h <= 55) return 'normal';
    if (h >= 60 && h <= 70) return 'high';
    return 'normal'; // Промежуточные значения
  }
  
  /**
   * Получение рекомендаций на основе текущего состояния
   */
  getRecommendations() {
    const pCat = this.getPressureCategory();
    const wCat = this.getWaterLevelCategory();
    const hCat = this.getOilLevelCategory();
    
    const key = `${pCat}_${wCat}_${hCat}`;
    
    const recommendations = {
      // P < 6
      'low_low_low': {
        status: 'warning',
        title: 'Низкое давление, низкие уровни воды и нефти',
        steps: [
          'Приоткрыть клапан на газовой линии для снижения отбора газа и повышения давления в аппарате до диапазона 6-16 МПа.',
          'Проверить герметичность системы, входное давление и работу предохранительных клапанов.',
          'Поднять уровень воды (W) до 30-70%, плавно прикрыв дренажный клапан воды.'
        ]
      },
      'low_low_normal': {
        status: 'warning',
        title: 'Низкое давление, низкий уровень воды',
        steps: [
          'Основная задача – поднять давление (P). Приоткрыть клапан на газовой линии.',
          'Уровень воды (W) низкий: прикрыть дренажный клапан воды для уменьшения откачки воды и поднятия уровня до 30-70%.',
          'Уровень нефти (H) оптимален (40-55%), регулировку клапана откачки нефти не производить.'
        ]
      },
      'low_low_high': {
        status: 'warning',
        title: 'Низкое давление, низкий уровень воды, высокий уровень нефти',
        steps: [
          'Сначала поднять давление: приоткрыть клапан на газовой линии.',
          'Снизить уровень нефти (H): приоткрыть клапан откачки нефти для усиления откачки до диапазона 40-55%.',
          'Уровень воды (W) низкий: прикрыть дренажный клапан воды. Действовать осторожно, чтобы не спровоцировать сброс нефти в дренаж.'
        ]
      },
      'low_normal_low': {
        status: 'warning',
        title: 'Низкое давление, низкий уровень нефти',
        steps: [
          'Поднять давление (P): приоткрыть клапан на газовой линии.',
          'Уровень воды (W) оптимален (30-70%), регулировку дренажного клапана воды не производить.',
          'Уровень нефти (H) низкий (20-30%): прикрыть клапан откачки нефти для уменьшения откачки и накопления уровня до 40-55%.'
        ]
      },
      'low_normal_normal': {
        status: 'warning',
        title: 'Низкое давление (уровни в норме)',
        steps: [
          'Сфокусироваться на нормализации давления. Плавно приоткрыть клапан на газовой линии до выхода в диапазон 6-16 МПа.',
          'Параметры W (30-70%) и H (40-55%) находятся в целевом диапазоне. Контролировать их, пока давление не выйдет на режим. Регулировку дренажного клапана воды и клапана откачки нефти не производить.'
        ]
      },
      'low_normal_high': {
        status: 'warning',
        title: 'Низкое давление, высокий уровень нефти',
        steps: [
          'Поднять давление (P): приоткрыть клапан на газовой линии.',
          'Снизить уровень нефти (H): приоткрыть клапан откачки нефти до достижения 40-55%.',
          'Уровень воды (W) оптимален. Контролировать, чтобы при регулировке H и P он не вышел за пределы 30-70%.'
        ]
      },
      'low_high_low': {
        status: 'critical',
        title: 'Низкое давление, высокий уровень воды, низкий уровень нефти',
        steps: [
          'Поднять давление: приоткрыть клапан на газовой линии.',
          'Снизить уровень воды (W): открыть дренажный клапан воды для усиленного сброса воды до уровня 30-70%.',
          'Поднять уровень нефти (H): прикрыть клапан откачки нефти. Высок риск выноса воды в нефтяной отсек. Приоритет – сброс воды.'
        ]
      },
      'low_high_normal': {
        status: 'warning',
        title: 'Низкое давление, высокий уровень воды',
        steps: [
          'Поднять давление (P): приоткрыть клапан на газовой линии.',
          'Снизить уровень воды (W): открыть дренажный клапан воды до уровня <70%.',
          'Уровень нефти (H) оптимален. Контролировать границу раздела, чтобы при сбросе воды не начался сброс нефти.'
        ]
      },
      'low_high_high': {
        status: 'critical',
        title: 'КРИТИЧЕСКИЙ РЕЖИМ: Низкое давление и высокие уровни',
        steps: [
          'Экстренно снизить уровни: полностью открыть дренажный клапан воды и клапан откачки нефти для предотвращения переполнения и выноса жидкости в газовую линию.',
          'После снижения уровней скорректировать клапан на газовой линии для плавного повышения давления.',
          'Проверить входной поток – возможно, требуется его уменьшение.'
        ]
      },
      
      // P 6-16 (нормальное)
      'normal_low_low': {
        status: 'warning',
        title: 'Низкие уровни воды и нефти',
        steps: [
          'Давление в норме. Регулировку клапана на газовой линии не производить.',
          'Поднять уровень воды (W): прикрыть дренажный клапан воды до диапазона 30-70%.',
          'Поднять уровень нефти (H): прикрыть клапан откачки нефти до диапазона 40-55%. Действовать плавно, чтобы не нарушить давление.'
        ]
      },
      'normal_low_normal': {
        status: 'warning',
        title: 'Низкий уровень воды',
        steps: [
          'Поддерживать давление (P) в оптимальном диапазоне 6-16 мПа.',
          'Поднять уровень воды (W): прикрыть дренажный клапан воды.',
          'Уровень нефти (H) оптимален (40-55%), регулировку клапана откачки нефти не производить.'
        ]
      },
      'normal_low_high': {
        status: 'warning',
        title: 'Низкий уровень воды, высокий уровень нефти',
        steps: [
          'Поддерживать давление (P).',
          'Поднять уровень воды (W): прикрыть дренажный клапан воды до 30-70%.',
          'Снизить уровень нефти (H): приоткрыть клапан откачки нефти до 40-55%.'
        ]
      },
      'normal_normal_low': {
        status: 'warning',
        title: 'Низкий уровень нефти',
        steps: [
          'Поддерживать давление (P) и уровень воды (W).',
          'Поднять уровень нефти (H): прикрыть клапан откачки нефти до 40-55%.'
        ]
      },
      'normal_normal_normal': {
        status: 'normal',
        title: 'НОРМАЛЬНЫЙ РЕЖИМ РАБОТЫ',
        steps: [
          'Поддерживать текущие установки клапана на газовой линии, дренажного клапана воды, клапана откачки нефти.',
          'Вести постоянный мониторинг параметров. Регулировка не требуется.'
        ]
      },
      'normal_normal_high': {
        status: 'warning',
        title: 'Высокий уровень нефти',
        steps: [
          'Поддерживать давление (P) и уровень воды (W).',
          'Снизить уровень нефти (H): приоткрыть клапан откачки нефти до 40-55%.'
        ]
      },
      'normal_high_low': {
        status: 'warning',
        title: 'Высокий уровень воды, низкий уровень нефти',
        steps: [
          'Поддерживать давление (P).',
          'Снизить уровень воды (W): открыть дренажный клапан воды до уровня ниже 70%.',
          'Поднять уровень нефти (H): прикрыть клапан откачки нефти. Риск выноса воды. Приоритет – сброс воды.'
        ]
      },
      'normal_high_normal': {
        status: 'warning',
        title: 'Высокий уровень воды',
        steps: [
          'Поддерживать давление (P).',
          'Снизить уровень воды (W): открыть дренажный клапан воды.',
          'Уровень нефти (H) оптимален. Контролировать границу раздела вода-нефть.'
        ]
      },
      'normal_high_high': {
        status: 'critical',
        title: 'АВАРИЙНАЯ СИТУАЦИЯ: Высокие уровни при нормальном давлении',
        steps: [
          'Срочно снизить уровни: полностью открыть дренажный клапан воды и клапан откачки нефти.',
          'Контролировать давление (P) – при резком сбросе жидкостей оно может упасть ниже 6 мПа, может потребоваться прикрыть клапан на газовой линии.',
          'Проверить производительность насосов откачки.'
        ]
      },
      
      // P > 16 (высокое)
      'high_low_low': {
        status: 'warning',
        title: 'Высокое давление, низкие уровни',
        steps: [
          'Снизить давление (P): прикрыть клапан на газовой линии для увеличения отбора газа до диапазона 6-16 мПа.',
          'Поднять уровни: прикрыть дренажный клапан воды (до 30-70%) и клапан откачки нефти (до 40-55%).',
          'Действовать плавно, высокое давление может быть причиной низких уровней.'
        ]
      },
      'high_low_normal': {
        status: 'warning',
        title: 'Высокое давление, низкий уровень воды',
        steps: [
          'Снизить давление: прикрыть клапан на газовой линии.',
          'Поднять уровень воды (W): прикрыть дренажный клапан воды до 30-70%.',
          'Уровень нефти (H) оптимален. Контролировать, чтобы при регулировке давления он не упал ниже 40%.'
        ]
      },
      'high_low_high': {
        status: 'warning',
        title: 'Высокое давление, низкий уровень воды, высокий уровень нефти',
        steps: [
          'Снизить давление (P): прикрыть клапан на газовой линии.',
          'Уровень воды (W) низкий: прикрыть дренажный клапан воды.',
          'Снизить уровень нефти (H): приоткрыть клапан откачки нефти. Сложная многофакторная регулировка. Действовать поэтапно.'
        ]
      },
      'high_normal_low': {
        status: 'warning',
        title: 'Высокое давление, низкий уровень нефти',
        steps: [
          'Снизить давление: прикрыть клапан на газовой линии.',
          'Уровень воды (W) оптимален (30-70%).',
          'Поднять уровень нефти (H): прикрыть клапан откачки нефти до 40-55%.'
        ]
      },
      'high_normal_normal': {
        status: 'warning',
        title: 'Высокое давление (уровни в норме)',
        steps: [
          'Основная задача – нормализовать давление. Плавно прикрыть клапан на газовой линии до выхода в диапазон 6-16 мПа.',
          'Параметры W (30-70%) и H (40-55%) оптимальны. Внимательно контролировать их при изменении давления. Регулировку дренажного клапана воды и клапана откачки нефти не производить.'
        ]
      },
      'high_normal_high': {
        status: 'warning',
        title: 'Высокое давление, высокий уровень нефти',
        steps: [
          'Снизить давление (P): прикрыть клапан на газовой линии.',
          'Уровень воды (W) оптимален.',
          'Снизить уровень нефти (H): приоткрыть клапан откачки нефти до 40-55%.'
        ]
      },
      'high_high_low': {
        status: 'critical',
        title: 'Высокое давление, высокий уровень воды, низкий уровень нефти',
        steps: [
          'Снизить давление: прикрыть клапан на газовой линии.',
          'Снизить уровень воды (W): открыть дренажный клапан воды до уровня <70%.',
          'Поднять уровень нефти (H): прикрыть клапан откачки нефти. Режим нестабилен. Приоритет – снижение давления и уровня воды.'
        ]
      },
      'high_high_normal': {
        status: 'warning',
        title: 'Высокое давление, высокий уровень воды',
        steps: [
          'Снизить давление (P): прикрыть клапан на газовой линии.',
          'Снизить уровень воды (W): открыть дренажный клапан воды.',
          'Уровень нефти (H) оптимален. Контролировать, чтобы при сбросе воды не начался сброс нефти.'
        ]
      },
      'high_high_high': {
        status: 'critical',
        title: 'КРИТИЧЕСКИ АВАРИЙНЫЙ РЕЖИМ: Высокое давление и переполнение',
        steps: [
          'Немедленно снизить давление: полностью открыть клапан на газовой линии на сброс газа.',
          'Экстренно снизить уровни: полностью открыть дренажный клапан воды и клапан откачки нефти.',
          'Рассмотреть возможность снижения входного потока или переключения на резервный сепаратор.',
          'Подготовиться к срабатыванию предохранительных клапанов.'
        ]
      }
    };
    
    return recommendations[key] || recommendations['normal_normal_normal'];
  }
  
  /**
   * Проверка аварийных состояний
   */
  checkAlerts() {
    const alerts = [];
    
    // Проверка давления (pressure возвращается в МПа)
    const pressure = this.calculatePressure();
    // Пороговые значения: 1 МПа (1000 кПа), 10 МПа (10000 кПа)
    if (pressure > 10) {
      alerts.push({
        type: 'critical',
        message: 'АВАРИЯ: Давление превышает 10 МПа! Уменьшите напор насоса.'
      });
    } else if (pressure < 1) {
      alerts.push({
        type: 'critical',
        message: 'АВАРИЯ: Давление ниже 1 МПа! Увеличьте напор насоса.'
      });
    }
    
    // Проверка уровня воды (в миллиметрах)
    const waterLevelMM = this.calculateWaterLevelMM();
    if (waterLevelMM > 2880) {
      alerts.push({
        type: 'critical',
        message: 'АВАРИЯ: Уровень воды превышает 2880 мм! Откройте клапан и сбросьте воду.'
      });
    } else if (waterLevelMM < 320) {
      alerts.push({
        type: 'critical',
        message: 'АВАРИЯ: Уровень воды ниже 320 мм! Закройте клапан.'
      });
    }
    
    // Проверка уровня нефти
    const oilLevel = this.calculateOilLevel();
    if (oilLevel > 15) {
      alerts.push({
        type: 'critical',
        message: 'АВАРИЯ: Уровень нефти > 15%. Откройте клапан нефти.'
      });
    } else if (oilLevel < 0.5) {
      alerts.push({
        type: 'warning',
        message: 'АВАРИЯ: Уровень нефти < 0.5%. Закройте клапан нефти.'
      });
    }
    
    // Проверка уровней при закрытых клапанах
    if (!this.state.waterValve && this.state.waterLevel > 65) {
      alerts.push({
        type: 'critical',
        message: 'АВАРИЯ: Уровень воды растёт, откройте водяной клапан!'
      });
    }
    
    if (!this.state.oilValve && this.state.oilLevel > 55) {
      alerts.push({
        type: 'critical',
        message: 'АВАРИЯ: Уровень нефти растёт, откройте нефтяной клапан!'
      });
    }
    
    if (!this.state.gasValve && this.state.gasLevel > 60) {
      alerts.push({
        type: 'critical',
        message: 'АВАРИЯ: Уровень газа растёт, откройте газовый клапан!'
      });
    }
    
    return alerts;
  }
  
  /**
   * Симуляция процесса разделения
   */
  simulate() {
    // Входящая эмульсия разделяется на фазы
    const inflow = this.state.inletFlow / 1000;
    this.state.waterLevel += inflow * 0.35;
    this.state.oilLevel += inflow * 0.4;
    this.state.gasLevel += inflow * 0.25;
    
    // Откачка при открытых клапанах
    if (this.state.waterValve) {
      this.state.waterLevel -= 0.35;
    } else {
      this.state.waterLevel += 0.4;
    }
    
    if (this.state.oilValve) {
      this.state.oilLevel -= 0.3;
    } else {
      this.state.oilLevel += 0.35;
    }
    
    if (this.state.gasValve) {
      this.state.gasLevel -= 0.25;
    } else {
      this.state.gasLevel += 0.3;
    }
    
    // Ограничение диапазонов
    this.state.waterLevel = Math.max(5, Math.min(80, this.state.waterLevel));
    this.state.oilLevel = Math.max(5, Math.min(80, this.state.oilLevel));
    this.state.gasLevel = Math.max(5, Math.min(80, this.state.gasLevel));
    
    // Уведомление слушателей
    this.notify();
  }
  
  /**
   * Переключение состояния клапана
   */
  toggleValve(valveType) {
    const key = `${valveType}Valve`;
    this.state[key] = !this.state[key];
    
    // Синхронизация со слайдером степени открытия
    if (valveType === 'water') {
      this.state.waterK = this.state.waterValve ? 0.5 : 0;
    } else if (valveType === 'oil') {
      this.state.oilU = this.state.oilValve ? 0.5 : 0;
    }
    
    this.notify();
  }
  
  /**
   * Увеличение входного потока (насос)
   */
  increasePumpFlow() {
    this.state.inletFlow = Math.min(8000, this.state.inletFlow + 50);
    this.state.flow = this.state.inletFlow;
    this.notify();
    return this.state.inletFlow;
  }
}
